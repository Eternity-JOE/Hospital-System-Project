# 挂号管理模块技术说明文档

> 作者：Member B  
> 日期：2025-12-23  
> 模块：挂号管理 + 科室管理

---

## 一、功能概述

本模块实现了医院挂号管理系统的核心功能，包括：

1. **科室管理**：科室的增删改查
2. **挂号管理**：患者挂号、退号、就诊完成、爽约标记
3. **智能排队调度**：基于优先级的排队算法
4. **号源管理**：分时段号源控制

---

## 二、核心亮点：智能排队调度算法

### 2.1 设计思想

借鉴**操作系统多级反馈队列（MLFQ）调度算法**的思想，实现了一套兼顾**紧急程度**和**公平性**的智能排队机制。

### 2.2 优先级规则

| 优先级因素 | 分值 | 说明 |
|-----------|------|------|
| 基础分 | +100 | 所有挂号的基础优先级 |
| 急诊 | +1000 | 急诊患者最高优先级 |
| 军人 | +200 | 军人优先 |
| 老人（≥65岁） | +150 | 老年人优先 |
| 儿童（≤14岁） | +150 | 儿童优先 |
| 复诊 | +100 | 同一医生复诊加分 |
| 等待时间 | +10/小时 | 防止"饥饿"，等待越久优先级越高 |
| 爽约记录 | -50/次 | 信用惩罚机制 |

### 2.3 算法公式

```
实际优先级 = 基础分(100) 
           + 急诊加分(0或1000)
           + 特殊人群加分(0~200)
           + 复诊加分(0或100)
           + 等待时间加分(小时数×10)
           - 爽约惩罚(爽约次数×50)
```

### 2.4 示例计算

| 患者 | 类型 | 身份 | 复诊 | 爽约次数 | 等待2小时后 | 最终优先级 |
|------|------|------|------|----------|-------------|------------|
| 张三 | 急诊 | 普通 | 否 | 0 | +20 | 1120 |
| 李四 | 普通 | 军人 | 是 | 0 | +20 | 420 |
| 王五 | 普通 | 老人 | 否 | 1 | +20 | 220 |
| 赵六 | 普通 | 普通 | 否 | 2 | +20 | 20 |

---

## 三、退号规则

### 3.1 规则说明

- **允许退号**：就诊时间前 **24小时以上** 可正常退号，号源自动返还
- **禁止退号**：就诊时间前 **不足24小时** 无法取消
- **退号后**：号源立即释放，其他患者可预约

### 3.2 时间计算

- 上午时段：以当天 8:00 为基准
- 下午时段：以当天 14:00 为基准

---

## 四、爽约机制

### 4.1 爽约判定

当患者预约后未到场就诊，由工作人员手动标记为"爽约"。

### 4.2 惩罚规则

- 每次爽约记录 **-50优先级分**
- 爽约记录**永久保留**，累计计算
- 多次爽约的患者在排队时会被排到后面

### 4.3 信用恢复

当前版本暂未实现信用恢复机制，可后续扩展：
- 连续N次正常就诊后减少爽约记录
- 设置爽约记录有效期

---

## 五、数据库设计

### 5.1 表结构

| 表名 | 说明 |
|------|------|
| sys_department | 科室表 |
| sys_registration | 挂号记录表 |
| sys_patient_record | 患者信誉记录表 |

> 数据库初始化操作请参考根目录 `README.md` 中的说明。

---

## 六、API 接口

### 6.1 科室管理

| 方法 | 接口 | 说明 |
|------|------|------|
| GET | /department/list | 查询所有科室 |
| POST | /department | 新增科室 |
| PUT | /department | 修改科室 |
| DELETE | /department/{id} | 删除科室 |

### 6.2 挂号管理

| 方法 | 接口 | 说明 |
|------|------|------|
| GET | /registration/list | 查询所有挂号 |
| GET | /registration/queue | 查询排队队列 |
| GET | /registration/slots | 查询号源情况 |
| POST | /registration | 新增挂号 |
| PUT | /registration | 修改挂号 |
| POST | /registration/cancel/{id} | 取消挂号（退号） |
| POST | /registration/complete/{id} | 完成就诊 |
| POST | /registration/noshow/{id} | 标记爽约 |
| DELETE | /registration/{id} | 删除记录 |

---

## 七、文件清单

### 后端文件

```
backend/src/main/java/com/example/hospital/
├── entity/
│   ├── Department.java          # 科室实体
│   ├── Registration.java        # 挂号实体
│   └── PatientRecord.java       # 患者信誉记录实体
├── mapper/
│   ├── DepartmentMapper.java    # 科室Mapper
│   ├── RegistrationMapper.java  # 挂号Mapper
│   └── PatientRecordMapper.java # 患者记录Mapper
├── service/
│   └── PriorityCalculator.java  # 优先级计算服务
└── controller/
    ├── DepartmentController.java    # 科室控制器
    └── RegistrationController.java  # 挂号控制器
```

### 前端文件

```
frontend/src/
├── api/
│   ├── department.js      # 科室API
│   └── registration.js    # 挂号API
└── views/
    ├── department/
    │   └── index.vue      # 科室管理页面
    └── registration/
        └── index.vue      # 挂号管理页面
```

### SQL文件

```
sql/
└── registration_tables.sql  # 建表及初始化数据
```

---

## 八、使用说明

详细的环境准备和启动步骤请参考根目录 `README.md`。

### 功能测试流程

1. 先在"科室管理"添加科室（或使用初始化数据）
2. 在"病人管理"添加患者
3. 在"挂号大厅"进行挂号操作
4. 点击"查看排队"查看实时排队队列

---

## 九、后续扩展建议

1. **医生排班**：与医生模块联动，实现按医生挂号
2. **短信提醒**：就诊前发送短信提醒
3. **自动爽约检测**：定时任务自动标记过期未就诊的挂号
4. **信用恢复机制**：连续正常就诊可减少爽约惩罚
5. **数据统计**：挂号量、爽约率等统计报表
